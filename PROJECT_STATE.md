# Project State

**Version:** 1.14.0
**Last Updated:** 2026-02-20
**Last Commit:** feat(admin): add job detail, auto-refresh, org stats, feature flags, activity export, broadcast, storage overview

## What's Implemented

### Infrastructure
- [x] Next.js 16 App Router with TypeScript strict mode
- [x] Tailwind CSS v4 + shadcn/ui configured
- [x] next-intl with de/en comprehensive translations
- [x] next-themes with ThemeProvider (dark mode fully functional)
- [x] zod installed for runtime validation
- [x] pnpm as package manager
- [x] ESLint configured
- [x] Complete folder structure from CLAUDE.md

### Database
- [x] Drizzle ORM configured with PostgreSQL (postgres.js driver)
- [x] drizzle.config.ts with schema path and migrations output
- [x] All enums defined (subscription_tier, subscription_status, org_member_role, consent_type, consent_status, job_status, locale, platform_role, invitation_status, invitation_type, form_status, form_visibility, form_completion_type, form_step_display_mode, product_status, media_context, analysis_form_assignment_status)
- [x] Schema: organizations (name, slug, settings, subscription tier/status [deprecated], default_locale, internal_notes, soft-delete)
- [x] Schema: products (name, slug, description, status, is_default, sort_order, seat limits [max_org_admins/managers/members], feature limits [max_analyses/forms/submissions/storage], feature flags [allow_forms/api_access/custom_branding/email_templates])
- [x] Schema: organization_products (1:1 org-plan junction, override columns for custom plans + feature flags, assigned_by/at, notes, unique on organization_id)
- [x] Schema: users (Supabase Auth ID, email, first/last/display name, phone, timezone, avatar, platform_role, locale)
- [x] Schema: organization_members (junction table, role enum, unique constraint, position, department_id, location_id, phone, status active/deactivated)
- [x] Schema: org_departments (org-scoped departments with unique name)
- [x] Schema: org_locations (org-scoped locations with address/city/country)
- [x] Schema: analysis_subjects (full_name, email, role_title, organization_id)
- [x] Schema: consents (consent_type, status, granted_at, revoked_at, ip_address)
- [x] Schema: analysis_jobs (status lifecycle, n8n timestamps, transcript path, error tracking)
- [x] Schema: reports (jsonb report_data, unique analysis_job_id, subject viewing)
- [x] Schema: team_invitations (email, role, status, token, expiry, invitation_type, organization_id, target_org_role)
- [x] Schema: audit_logs (append-only, actor, action, entity, metadata, IP, indexed)
- [x] Schema: platform_settings (key-value store with typed defaults)
- [x] Schema: email_templates (slug, de/en subject+body, variables, system flag)
- [x] Schema: org_email_template_overrides (organization_id + template_slug unique, subject/body de/en, updated_by)
- [x] Schema: notifications (recipientId, type, title, body, link, isRead, metadata, indexed)
- [x] Schema: integration_secrets (service, key, encrypted_value, iv, is_sensitive, AES-256-GCM encryption)
- [x] Schema: forms (title, slug, status, visibility, step display mode, completion config, versioning, soft-delete)
- [x] Schema: form_versions (formId, versionNumber, jsonb schema, publishedAt/By, unique constraint)
- [x] Schema: form_organization_assignments (formId, organizationId, assignedBy, unique constraint)
- [x] Schema: form_submissions (formId, formVersionId, organizationId, submittedBy, jsonb data/metadata)
- [x] Schema: media_files (bucket, path, filename, mime_type, size, context, context_entity_id, uploaded_by, alt_text)
- [x] Schema: analysis_form_assignments (analysis_id, form_id, form_version_id, employee_id, token, token_expires_at, status lifecycle, due_date, submission_id, reminder_count, unique on analysis_id+form_id)
- [x] Drizzle DB client instance
- [x] TypeScript inferred types (Select + Insert for all tables including team_invitations, audit_logs, platform_settings, email_templates, notifications, integration_secrets, forms, form_versions, form_organization_assignments, form_submissions, products, organization_products, media_files, analysis_form_assignments, org_email_template_overrides)
- [x] Supabase browser client (@supabase/ssr)
- [x] Supabase server client (cookie-based auth)
- [x] Supabase admin client (service role, superadmin only)
- [x] Supabase middleware helper (session refresh)
- [x] RLS SQL templates (enable RLS + tenant isolation policies)
- [x] Schema pushed to live Supabase database
- [ ] RLS policies applied to Supabase (requires running SQL migrations against live DB)

### Authentication
- [x] Supabase Auth integration (email/password + magic link)
- [x] Login page with email/password form, magic link, OAuth placeholders
- [x] Register page with name, email, password form
- [x] Auth layout with centered card design
- [x] Auth callback API route (magic link + OAuth code exchange)
- [x] Middleware: auth check (protected route redirect to login)
- [x] Middleware: subdomain to org resolution (production subdomains + dev fallback)
- [x] Middleware: locale detection via next-intl
- [x] next-intl navigation helpers (Link, useRouter, usePathname, redirect)
- [ ] OAuth (Google/Microsoft) - placeholders only
- [ ] SSO/SAML - not started

### RBAC
- [x] Role definitions (superadmin, org_admin, manager, member) with hierarchy
- [x] Platform role definitions (superadmin, staff) with hierarchy
- [x] Permission helper functions (canManageOrganization, canRequestAnalysis, canViewReport, canManageTeam, canAccessSuperadmin, canManagePlatformTeam)
- [x] Role permissions map for client-side UX checks
- [x] Role-based middleware guards (auth redirect for protected routes)
- [x] requirePlatformRole server-side guard for admin pages
- [x] Staff/superadmin filtering on admin sidebar nav items
- [ ] UI-level permission checks in dashboard components (hooks available, not yet wired)

### Hooks
- [x] useTenant - client-side organization context (subdomain or dev query param)
- [x] useRole - client-side user role in current org + platform role (UX only, not security)

### Validations
- [x] Zod schemas for admin forms (profile update, team invite/update/remove, org create/delete/update — org schemas updated for plan system)
- [x] Zod schemas for form builder (formSchemaValidator, formFieldValidator, formMetaValidator, createSubmissionValidator)

### Form Builder
- [x] Complete TypeScript type system for JSON form schemas (11 field types, conditional logic, validation, multi-step)
- [x] Zod validation: form schema, field, metadata, and dynamic submission validators
- [x] Helper functions: getForm, getFormBySlug, getFormVersion, canOrganizationAccessForm, createFormVersion, publishForm
- [x] Visual drag-and-drop builder with @dnd-kit (palette, canvas, settings panel)
- [x] 3-column layout: field palette (240px), canvas (flex), settings (320px)
- [x] Multi-step support with step tabs (add/remove/rename)
- [x] Field settings: general, options (radio/checkbox), validation, conditional logic, hidden
- [x] Auto-save with 3-second debounce + explicit save (new version) + publish
- [x] Form preview modal
- [x] Forms list page with data table and CRUD actions
- [x] New form page with metadata entry and slug generation
- [x] Form editor page with full builder
- [x] "Formulare" nav item in admin sidebar
- [x] 12 form server actions (CRUD, versioning, publishing)
- [x] Form Renderer with progress_bar (Typeform-style) and tabs (classic) display modes
- [x] 11 interactive field render components (text, textarea, number, email, phone, date, radio, checkbox, csat, rating, hidden)
- [x] Radio/checkbox button variant, CSAT color gradient, rating with star/heart/thumb icons
- [x] Conditional logic evaluation hook (useConditionalFields)
- [x] Step-level and field-level validation with inline errors
- [x] Form completion component (thank_you with animation, redirect)
- [x] Dashboard forms page with card layout and submission status
- [x] Dashboard form fill page with access checks and already-submitted detection
- [x] Form submission server action with org access check and metadata tracking
- [x] Admin submissions page with stats, dynamic table, filters, detail dialog, delete
- [x] CSV and XLSX export via API route with filter support
- [x] "Forms" nav item in dashboard sidebar
- [x] Organization assignment panel (two modes: all_organizations / assigned, search, list, remove)
- [x] Form settings dialog (3 tabs: General, Completion, Organizations)
- [x] Publish validation dialog (schema validation before publish, version management)
- [x] Status transitions: publish, unpublish, archive, reactivate
- [x] Builder wired to settings dialog and publish validation dialog

### Form Assignment (Analyses)
- [x] Assign published forms to analysis employees via token-based email link
- [x] Status lifecycle: pending → sent → opened → completed
- [x] Token generation (32 bytes, 30-day expiry) with public fill route
- [x] Public form-fill page (`/form-fill/[token]`) with org branding (logo, colors), no login required
- [x] Public layout (`src/app/[locale]/(public)/layout.tsx`) for unauthenticated routes
- [x] Middleware updated: `/form-fill/` added to public patterns
- [x] FormsSection component on analysis detail page (status badges, due dates, overdue warnings, reminder/remove actions, expandable timeline/responses)
- [x] AssignFormDialog component (form select, optional deadline, sends email on confirm)
- [x] FormResponsesView component (renders submission data with field type-specific formatting)
- [x] Server actions: `getAnalysisFormAssignments`, `getAvailableFormsForAssignment`, `assignFormToAnalysis`, `sendFormReminder`, `removeFormAssignment`
- [x] Public server actions: `getFormByToken`, `submitFormViaToken`
- [x] Email templates seeded: `form-assignment` (invitation), `form-assignment-reminder` (reminder)
- [x] Audit actions: `analysis.form_assigned`, `analysis.form_unassigned`
- [x] i18n: `analyses.detail.forms` + `formFill` namespaces (DE + EN)

### Plans / Products (Tarife)
- [x] DB schema: `products` table with seat limits and feature limits
- [x] DB schema: `organization_products` junction table (1:1, unique on org_id) with override columns
- [x] `productStatusEnum` (active, archived)
- [x] Limits resolution helper (`src/lib/products/limits.ts`): resolves effective limits from product defaults + overrides
- [x] Utility functions: `getOrganizationLimits`, `getOrganizationUsage`, `checkLimit`, `canAddMember`, `getOrganizationProduct`
- [x] Seed script with 4 default plans: Starter, Professional, Enterprise, Custom
- [x] Org creation assigns plan (productId from form or platform default)
- [x] Org list, detail, and edit pages show plan name instead of subscription tier
- [x] Platform settings: default plan selector (replaces default tier)
- [x] Audit actions for plan changes (plan.assigned, plan.changed, plan.removed)
- [x] subscription_tier/maxMembers/maxAnalysesPerMonth deprecated on organizations table
- [x] Admin Plans CRUD UI (`/admin/plans`): list, detail, create, edit pages with full server actions, feature flag toggles
- [x] Plans nav item in admin sidebar (CreditCard, superadmin-only)
- [x] i18n for admin.plans namespace (DE: "Tarife", EN: "Plans")
- [x] Org-admin plan view (`/dashboard/plan`): plan details + usage bars for seats, analyses, forms, storage
- [x] Dashboard plan widget: compact usage overview with progress bars
- [x] Plan nav item in dashboard sidebar (CreditCard, between Team and Settings)
- [x] Seat limit enforcement: `canAddMember()` check in invitation acceptance flows
- [x] Form submission limit enforcement: `checkLimit()` in `submitForm()` action
- [x] User-facing limit error messages (seat_limit_reached, form_submission_limit_reached)
- [x] Org-admin plan view redesigned with `PlanUsageBar` (color-coded) + contact upgrade button
- [ ] Analysis job limit enforcement (analysis upload flow not yet built)
- [ ] Storage usage tracking (storage not yet implemented)

### Org Settings
- [x] Settings > Allgemein (`/settings`): view/edit org info (name, address, contact, business data, industry combobox)
- [x] Settings > Tarif (`/settings/plan`): redesigned with `PlanUsageBar`, upgrade contact, reset info
- [x] Settings > Branding (`/settings/branding`): logo upload, favicon upload, 4 color pickers, live preview, WCAG warnings, email footer
- [x] Branding applied in dashboard layout: CSS variables per org, favicon, org logo in sidebar
- [x] DB: 16 new columns on `organizations` (address, contact, business, branding, favicon, email_footer)
- [x] `src/lib/branding/color-utils.ts`: hexToHsl, getContrastRatio, meetsWCAG_AA
- [x] `src/lib/branding/apply-branding.ts`: getOrgBranding() helper
- [x] `src/components/org/plan-usage-bar.tsx`: reusable usage bar component
- [x] `src/components/org/branding-preview.tsx`: live branding preview with WCAG warnings
- [x] `src/components/ui/combobox.tsx`: searchable combobox with freetext
- [x] Platform setting: `contact.upgrade_email`
- [x] Settings > Mediathek (`/settings/media`): grid/list, upload 10 MB, löschen mit Verwendungs-Check, Speicher-Progress
- [x] Settings > Benachrichtigungen (`/settings/notifications`): 11 Toggles in 5 Gruppen, Upsert in organization_notification_settings
- [x] Settings > Integrationen (`/settings/integrations`): aufgewerteter Platzhalter mit 3 Karten + mailto-Button
- [x] DB: `organization_notification_settings` Tabelle (11 boolean Felder, unique on org_id)
- [x] `src/lib/notifications/should-notify.ts`: shouldNotifyOrg() + getNotificationSettings() mit Defaults
- [x] i18n: org.settings.media/notifications/integrations Namespaces (DE + EN)

### Org Email Templates
- [x] `org_email_template_overrides` DB table with unique(organization_id, template_slug)
- [x] Org-level override for 6 templates: org-invitation, direct-create-welcome, analysis-complete, analysis-shared, form-assignment, form-assignment-reminder
- [x] `sendTemplatedEmail` extended with optional `organizationId` — checks org override first, falls back to global template
- [x] `getOrgEmailLayoutConfig(orgId)` — merges org branding (logo, colors) with platform email layout
- [x] Settings > E-Mails page (`/settings/emails`) with template list, status badges (Angepasst/Standard), edit/test/reset
- [x] Template editor with DE/EN tabs, RichTextEditor, variable sidebar, live preview with org branding
- [x] Test send with org branding to current user
- [x] Reset to default (deletes org override, falls back to global template)
- [x] All existing `sendTemplatedEmail` callers updated to pass `organizationId`
- [x] Professional-warm, neutral copy for all 9 email templates (DE + EN), American English
- [x] Seed scripts: `seed-missing-templates.mjs` (direct-create-welcome, analysis-shared), `update-all-email-templates.mjs` (all 9)
- [x] Superadmin reset defaults updated with new copy for all 9 templates
- [x] Sidebar nav item: Settings > E-Mails (Mail icon, org_admin only)
- [x] i18n: org.settings.emails namespace (DE + EN)

### UX Polish
- [x] Skeleton loading system (5 composites: Table, Card, Form, Detail, Stats) with shimmer animation
- [x] 21 loading.tsx files (15 admin + 6 dashboard) for Suspense-based skeleton screens
- [x] Page transitions (fade-in + slide-up, 200ms) via PageTransition component in both layouts
- [x] Navigation progress bar (3px top-fixed, z-100, captures link clicks)
- [x] Dashboard breadcrumbs in header (auto-generated from URL path, matching admin breadcrumbs)
- [x] Admin breadcrumbs in header (auto-generated from URL path)
- [x] EmptyState reusable component with icon, title, description, actions
- [x] Toast with undo utility (executeWithUndo, 8s undo window)
- [x] useCountUp hook (animated number counter with rAF + ease-out)
- [x] Micro-interactions CSS (card hover lift, sidebar active indicator, button press, list item enter)
- [x] Reduced motion support (prefers-reduced-motion disables all animations)
- [x] i18n: ui.empty namespace (12 empty states, DE + EN) and ui.toast namespace (4 keys)

### UI / Pages
- [x] Root layout with fonts, metadata, ThemeProvider, and NavigationProgress
- [x] Locale layout with NextIntlClientProvider
- [x] Auth layout + placeholder pages (login, register)
- [x] Dashboard app shell (sidebar + header + breadcrumbs)
- [x] Responsive sidebar (desktop fixed, mobile Sheet) with active indicator
- [x] Header with mobile menu, breadcrumbs, dark mode toggle, user dropdown
- [x] Dark mode toggle component (light/dark/system)
- [x] Dashboard page with stats cards and activity section
- [x] Analyses page with EmptyState component
- [x] Team page with EmptyState component
- [x] Settings page with profile/org/notifications sections
- [x] Superadmin layout with grouped admin sidebar v2 (5 groups: Main, Content, Customers, Platform, System; 10 nav items + collapsible Settings with 3 children; user footer with avatar, name, role, profile link, sign-out)
- [x] Dashboard sidebar with 6 nav items (Dashboard, Analyses, Forms, Team, Plan, Settings)
- [x] Superadmin dashboard page with live stats, system health, quick actions, recent activity
- [x] Reusable StatCard component (`src/components/admin/stat-card.tsx`)
- [x] Platform-wide User Management page (`/admin/users`) with search, org memberships
- [x] System Health Dashboard on admin dashboard (Supabase, Resend, n8n, Deepgram)
- [x] Global Search (Cmd+K) in admin header (orgs, users, jobs)
- [x] Superadmin Profile page with editable form
- [x] Superadmin Team management page (members table, invite dialog, role change, remove, invitations tab)
- [x] Superadmin Organizations list page with table
- [x] Superadmin Create Organization page with form
- [x] Superadmin Organization detail page with danger zone (soft-delete), invitations tab, statistics tab (usage stats), and edit button
- [x] Superadmin Organization edit page with basic data, status & plan, settings, internal notes
- [x] Org creation form with "First Org-Admin" section and auto-invitation
- [x] Superadmin Activity page with audit log table, action/period filters, pagination, CSV export
- [x] Superadmin Settings page with 4 tabs (General, Invitations, Organizations, Analysis)
- [x] Superadmin Email Templates page (`/admin/settings/emails`) with editor, preview, variables, reset, test send
- [x] Email Layout page (`/admin/settings/email-layout`) with logo, colors, footer, border radius, live preview, test send
- [x] Impersonation: "View as Organization" button on org detail (superadmin only)
- [x] Impersonation banner in dashboard layout with signed cookie and 2h timeout
- [x] NotificationBell component in admin header (popover, polling, unread badge)
- [x] Notifications page (`/admin/notifications`) with All/Unread tabs, mark-all-read, pagination, broadcast dialog (superadmin)
- [x] Analysis Jobs page (`/admin/jobs`) with n8n health check, stats, filters, retry/cancel actions, auto-refresh (10s polling), clickable job IDs
- [x] Job Detail page (`/admin/jobs/[id]`) with visual timeline, info cards, metadata/payload, error details, test mode badge
- [x] Integrations page (`/admin/integrations`) with encrypted secret management (Supabase, Resend, n8n, Vercel, Payment placeholder)
- [x] Breadcrumbs component in admin header (auto-generated from URL path)
- [x] Media Library page (`/admin/media`) with grid/list views, upload dialog, preview, delete with usage check, bulk delete, sync, context filter, search, storage overview (per-org quota usage)
- [x] "Mediathek" nav item in admin sidebar (Image icon, superadmin-only)
- [x] Staff permission filtering on admin sidebar (Settings hidden for staff)
- [x] Home page (redirects to dashboard)
- [x] Invitation acceptance page (`/invite/[token]`) with token validation, register, and accept flows
- [x] **Org User Management** (`/users`): User list with tabs (All, Active, Deactivated, Invitations), search, stat cards, seat usage bar
- [x] Add User dialog with Email Invite and Direct Create tabs, role selector, department/location comboboxes
- [x] Edit User dialog (position, department, location, phone, name)
- [x] Change Role dialog with radio group and seat impact
- [x] Deactivate/Reactivate dialog with consequences list
- [x] Remove User dialog with name confirmation
- [x] Manage Departments dialog (CRUD with usage count, delete protection)
- [x] Manage Locations dialog (CRUD with address/city/country, usage count, delete protection)
- [x] Reusable `AvatarDisplay` component with initials fallback and deterministic color
- [ ] Analysis upload flow
- [ ] Report viewer

### Server Actions
- [x] updateProfile - update current user's profile fields
- [x] getTeamMembers - list platform team members
- [x] getPendingInvitations - list pending team invitations
- [x] inviteTeamMember - invite new platform team member (or promote existing user)
- [x] updateTeamMemberRole - change a team member's platform role
- [x] removeTeamMember - revoke platform role from a team member
- [x] cancelInvitation - cancel a pending team invitation
- [x] getOrganizations - list all organizations
- [x] getOrganizationById - get single organization details
- [x] createOrganization - create new organization with slug uniqueness check
- [x] deleteOrganization - soft-delete an organization
- [x] updateOrganization - update org details with slug validation and audit logging
- [x] checkSlugAvailability - real-time slug uniqueness and reserved word check
- [x] getPlatformStats - get platform-wide stats (9 metrics with trends)
- [x] getRecentActivity - get last 8 audit log entries for dashboard
- [x] getAllPlatformUsers - list all users with org memberships and search
- [x] getSystemHealth - parallel health checks for all integrations
- [x] globalSearch - search orgs, users, jobs across platform
- [x] validateInviteToken - validate invitation token and return invitation info
- [x] acceptInvitation - accept invitation for logged-in users (platform role or org membership)
- [x] registerAndAcceptInvitation - register new account and accept invitation in one step
- [x] createOrganizationWithAdmin - create org and org-admin invitation in one step
- [x] getOrgInvitations - list invitations for a specific organization
- [x] resendOrgInvitation - cancel old invitation and create new one
- [x] getOrgUsers - join members + users + departments + locations
- [x] getOrgUserStats - counts for total, active, deactivated, pending invitations
- [x] getOrgInvitations (org-level) - pending/expired invitations for the org
- [x] getOrgDepartments / getOrgLocations - CRUD data with usage counts
- [x] getOrgSeats - limits + usage for seat display
- [x] inviteUser - create org invitation with email, role, metadata
- [x] createUserDirect - create Supabase Auth user + DB record + membership
- [x] updateMember - update position, department, location, phone, name
- [x] changeUserRole - with last-admin protection and seat limit check
- [x] deactivateUser - set status=deactivated, self/last-admin protection
- [x] reactivateUser - set status=active with seat limit check
- [x] removeUserFromOrg - hard delete with name confirmation
- [x] resendInvitation (org-level) - cancel old, create new with same metadata
- [x] revokeInvitation (org-level) - set status=cancelled
- [x] createDepartment / updateDepartment / deleteDepartment (with usage check)
- [x] createLocation / updateLocation / deleteLocation (with usage check)
- [x] cancelOrgInvitation - cancel an org invitation
- [x] getAnalysisFormAssignments - list form assignments for an analysis with form/employee/submission data
- [x] getAvailableFormsForAssignment - published forms accessible to org minus already-assigned
- [x] assignFormToAnalysis - create assignment, generate token, send email, set status to sent
- [x] sendFormReminder - send reminder email, increment reminder count
- [x] removeFormAssignment - delete assignment (blocked if completed)
- [x] getFormByToken - validate token, update status to opened, load branding (public)
- [x] submitFormViaToken - create submission, mark assignment completed (public)
- [x] getOrgEmailTemplates - load 6 org-relevant templates with override status
- [x] getOrgEmailLayoutConfigAction - get org email layout config for preview
- [x] saveOrgEmailTemplate - upsert org email template override
- [x] resetOrgEmailTemplate - delete org override, return global template values
- [x] sendOrgTestEmail - send test email with org branding to current user
- [x] logAudit - append audit log entry (23 action types incl. notification.broadcast)
- [x] getAuditLogs - list audit logs with action/period filters and pagination
- [x] exportAuditLogs - export filtered audit logs as CSV (up to 10k entries)
- [x] getOrgUsageStats - per-org usage stats (members, jobs, dossiers, last activity)
- [x] updatePlatformSettings - update platform settings with audit logging
- [x] getSetting / setSetting / getAllSettings - typed platform settings helpers
- [x] updateEmailTemplate - update email template content with audit logging
- [x] resetEmailTemplate - reset system template to default content
- [x] sendTemplatedEmail / renderTemplatedEmail - email send helper with DB templates
- [x] startImpersonationAction - start impersonation as org admin with audit logging
- [x] endImpersonationAction - end impersonation and redirect back to admin
- [x] getRecentNotifications - get 10 most recent notifications for current user
- [x] getUnreadCount - get count of unread notifications
- [x] getAllNotifications - list notifications with unread filter and pagination
- [x] markNotificationRead - mark a single notification as read
- [x] markAllNotificationsRead - mark all notifications as read
- [x] createNotification - create notification for user or broadcast to all superadmins
- [x] sendBroadcast - broadcast notification to all org admins or all users of an org (superadmin)
- [x] getOrganizationsForBroadcast - list orgs for broadcast dialog
- [x] getAnalysisJobs - list analysis jobs with status/org filters and pagination
- [x] getAnalysisJobStats - get counts by status
- [x] cancelAnalysisJob - cancel pending/processing job with audit logging
- [x] retryAnalysisJob - reset failed/cancelled job to pending with audit logging
- [x] checkN8nHealthAction - check n8n webhook connectivity
- [x] getAnalysisJobDetail - full job detail with org, subject, requester data
- [x] sendTestTemplateEmail - send test email with unsaved template content and layout
- [x] saveIntegrationSecrets - save encrypted secrets for a service
- [x] getIntegrationSecretsForUI - load masked secrets for display
- [x] testSupabaseConnection - test Supabase API connectivity
- [x] testResendConnection - test Resend API connectivity
- [x] testN8nConnection - test n8n health endpoint
- [x] sendTestEmail - send test email via Resend
- [x] rotateN8nSecret - generate and store new random secret
- [x] loadFromEnv - import ENV values into encrypted DB storage
- [x] getAvailableForms - list published forms accessible to current org
- [x] getFormBySlugForRendering - load form by slug with access check and version
- [x] submitForm - submit form with org access check, validation, and metadata
- [x] getFormWithSchema - get form with current version schema (admin)
- [x] getSubmissionStats - total, this week, avg duration (admin)
- [x] getSubmissions - paginated submissions with org/date/version filters (admin)
- [x] getSubmissionOrganizations - organizations with submissions for filter dropdown (admin)
- [x] getFormVersionNumbers - version numbers for filter dropdown (admin)
- [x] deleteSubmission - permanently delete a submission (admin)
- [x] getFormAssignments - get organizations assigned to a form (admin)
- [x] searchOrganizations - autocomplete search excluding already-assigned orgs (admin)
- [x] assignFormToOrganization - assign form to org with audit log (admin)
- [x] removeFormOrganizationAssignment - remove org assignment with audit log (admin)
- [x] setFormVisibility - toggle all_organizations/assigned visibility (admin)
- [x] setFormStatus - status transitions draft/published/archived (admin)
- [x] publishFormWithValidation - validate schema and publish with version management (admin)
- [x] getEmailTemplates - list email template slugs for completion config (admin)
- [x] getAllProducts - list all plans ordered by sortOrder (admin)
- [x] getProductById - get single plan by ID (admin)
- [x] getProductOrganizations - list orgs assigned to a plan (admin)
- [x] getProductOrgCount - count of orgs assigned to a plan (admin)
- [x] createProduct - create new plan with slug validation and default handling (admin)
- [x] updateProduct - update plan details with slug uniqueness check (admin)
- [x] archiveProduct - archive plan (blocked if orgs assigned) (admin)
- [x] reactivateProduct - reactivate archived plan (admin)
- [x] assignOrganizationPlan - assign plan to org (delete + insert) (admin)
- [x] removeOrganizationPlan - remove org's plan assignment (admin)
- [x] getOrgPlanOverview - get org's plan name, limits, and usage for dashboard (org)
- [x] listMedia - list media files with context/search filters (admin)
- [x] uploadMedia - upload file to Supabase Storage and track in media_files (admin)
- [x] deleteMedia - delete file with usage check and force option (admin)
- [x] bulkDeleteMedia - bulk delete with usage checks (admin)
- [x] syncMedia - sync media_files table with Supabase Storage (admin)
- [x] getMediaPublicUrl - get public URL for a media file (admin)
- [x] getStorageStats - storage usage stats by org and context with quota info (admin)

### Media Library
- [x] `media_files` DB table with context enum (email_logo, email_template, form_header, org_logo, report_asset, general)
- [x] Storage path helpers (`src/lib/media/storage-paths.ts`)
- [x] File utility helpers (`src/lib/media/file-utils.ts`)
- [x] Upload tracking helper (`src/lib/media/track-upload.ts`)
- [x] Usage check helper (`src/lib/media/check-usage.ts`)
- [x] Storage sync helper (`src/lib/media/sync-storage.ts`)
- [x] Grid and list views with selection, filtering, search
- [x] Upload dialog with drag-and-drop
- [x] File preview dialog with image display
- [x] Delete with usage check and force-delete option
- [x] Bulk delete with usage checks
- [x] Storage sync (adds untracked files, removes orphaned DB entries)
- [x] Copy public URL to clipboard
- [x] Context-based filtering (6 contexts)
- [x] Email logo upload wired to media_files tracking
- [x] Audit events: media.uploaded, media.deleted, media.bulk_deleted, media.synced
- [x] i18n: admin.media namespace (DE + EN, 45+ keys)

### Integrations
- [x] Integration secrets encryption (AES-256-GCM, `src/lib/crypto/secrets.ts`)
- [x] Secret caching with 5-minute TTL (`src/lib/crypto/secrets-cache.ts`)
- [x] Cache invalidation on secret save, rotate, and env import
- [x] n8n webhook trigger (`triggerN8nWebhook` - cached secrets with ENV fallback)
- [x] n8n callback handler (`POST /api/webhooks/n8n/analysis-complete` - cached secrets with ENV fallback)
- [x] n8n health check (`checkN8nHealth` - cached secrets with ENV fallback)
- [x] Resend email (package installed, `sendTemplatedEmail` with cached DB secrets + ENV fallback)
- [x] Platform settings and integration secrets cleanly separated (non-sensitive config vs encrypted API keys)
- [x] Supabase Storage upload flow (media library + email logo)

## What's NOT Implemented Yet
- Analysis upload + job creation flow
- n8n integration (webhook trigger + callback)
- Report generation + viewer
- Resend email (magic link, notifications, team invitations)
- Supabase Storage RLS policies (uploads work via admin client, RLS not yet applied)
- OAuth providers (Google, Microsoft)
- SSO/SAML for Enterprise
- Consent management UI
- Testing (Vitest, Playwright)
- Avatar upload in profile page
- Email templates created (React components) but Resend not yet integrated
- Team invitation email sending (invitations created but email not sent)
- Invitation acceptance page needs email notifications when invitation is accepted

## Known Issues / Tech Debt
- Admin sidebar user footer now shows real user data (name, avatar, role) from server layout
- Sidebar organization label is placeholder - useTenant hook available but not yet wired
- Dashboard stats are live from DB queries (resolved in v1.13.0)
- RLS policies are defined as SQL files but not yet applied to a live Supabase instance
- Next.js 16 shows deprecation warning for middleware convention (will be renamed to "proxy" in future)
- useRole hook queries Supabase directly from client - consider server-side session enrichment for performance
- Profile form uses toast in render (should use useEffect for toast side effects)
- Team invitations don't send actual emails yet (Resend not integrated)

## File Map (Key Files)
- `src/app/layout.tsx` - Root layout with fonts, metadata, ThemeProvider
- `src/app/[locale]/layout.tsx` - Locale layout with NextIntlClientProvider
- `src/app/[locale]/page.tsx` - Redirects to dashboard
- `src/app/[locale]/(dashboard)/layout.tsx` - Dashboard layout with AppShell
- `src/app/[locale]/(superadmin)/layout.tsx` - Admin layout with AdminSidebar
- `src/app/[locale]/(superadmin)/admin/page.tsx` - Admin dashboard with real stats
- `src/app/[locale]/(superadmin)/admin/actions.ts` - All admin server actions
- `src/app/[locale]/(superadmin)/admin/profile/page.tsx` - Profile page (server)
- `src/app/[locale]/(superadmin)/admin/profile/profile-form.tsx` - Profile form (client)
- `src/app/[locale]/(superadmin)/admin/team/page.tsx` - Team page (server)
- `src/app/[locale]/(superadmin)/admin/team/team-page-client.tsx` - Team management (client)
- `src/app/[locale]/(superadmin)/admin/organizations/page.tsx` - Org list (server)
- `src/app/[locale]/(superadmin)/admin/organizations/orgs-page-client.tsx` - Org list (client)
- `src/app/[locale]/(superadmin)/admin/organizations/new/page.tsx` - Create org (server)
- `src/app/[locale]/(superadmin)/admin/organizations/new/create-org-form.tsx` - Create org form (client)
- `src/app/[locale]/(superadmin)/admin/organizations/[id]/page.tsx` - Org detail (server)
- `src/app/[locale]/(superadmin)/admin/organizations/[id]/org-detail-client.tsx` - Org detail (client)
- `src/app/[locale]/(superadmin)/admin/organizations/[id]/edit/page.tsx` - Org edit (server)
- `src/app/[locale]/(superadmin)/admin/organizations/[id]/edit/org-edit-client.tsx` - Org edit form (client)
- `src/components/admin/stat-card.tsx` - Reusable stat card component with icon, value, trend
- `src/app/[locale]/(auth)/invite/[token]/page.tsx` - Invitation acceptance page (server)
- `src/app/[locale]/(auth)/invite/[token]/invite-client.tsx` - Invitation acceptance UI (client)
- `src/app/[locale]/(auth)/invite/[token]/actions.ts` - Invitation validation and acceptance server actions
- `src/components/layout/app-shell.tsx` - Main wrapper (sidebar + header + content)
- `src/components/layout/sidebar.tsx` - Navigation sidebar with nav links
- `src/components/layout/header.tsx` - Top bar with menu toggle, theme, user menu
- `src/app/[locale]/(superadmin)/admin/activity/page.tsx` - Activity page (server)
- `src/app/[locale]/(superadmin)/admin/activity/activity-page-client.tsx` - Activity log table (client)
- `src/lib/audit/log.ts` - Audit logging helper (logAudit, AuditAction type)
- `src/lib/db/schema/audit-logs.ts` - Audit logs table schema
- `src/app/[locale]/(superadmin)/admin/settings/page.tsx` - Settings page (server)
- `src/app/[locale]/(superadmin)/admin/settings/settings-page-client.tsx` - Settings form (client)
- `src/lib/settings/platform.ts` - Platform settings helper (typed key-value store)
- `src/lib/db/schema/platform-settings.ts` - Platform settings table schema
- `src/lib/db/schema/email-templates.ts` - Email templates table schema
- `src/app/[locale]/(superadmin)/admin/settings/emails/page.tsx` - Email templates page (server)
- `src/app/[locale]/(superadmin)/admin/settings/emails/email-templates-client.tsx` - Email templates editor (client)
- `src/lib/email/send.ts` - Email send helper with DB template rendering, configurable layout, and org override support
- `src/app/[locale]/(dashboard)/settings/emails/page.tsx` - Org email templates page (server)
- `src/app/[locale]/(dashboard)/settings/emails/org-email-templates-client.tsx` - Org email templates editor (client)
- `src/app/[locale]/(dashboard)/settings/emails/actions.ts` - Org email template server actions
- `src/app/[locale]/(superadmin)/admin/settings/email-layout/page.tsx` - Email layout page (server)
- `src/app/[locale]/(superadmin)/admin/settings/email-layout/email-layout-client.tsx` - Email layout config (client)
- `src/app/[locale]/(superadmin)/admin/settings/email-layout/actions.ts` - Email layout server actions
- `src/lib/auth/impersonation.ts` - Impersonation cookie management (sign/verify/parse)
- `src/components/layout/impersonation-banner.tsx` - Impersonation banner component
- `src/app/[locale]/(dashboard)/impersonation-actions.ts` - End impersonation server action
- `src/components/admin/notification-bell.tsx` - NotificationBell popover with polling
- `src/lib/notifications/create.ts` - Notification creation helper with broadcast support
- `src/lib/db/schema/notifications.ts` - Notifications table schema
- `src/app/[locale]/(superadmin)/admin/notifications/page.tsx` - Notifications page (server)
- `src/app/[locale]/(superadmin)/admin/notifications/notifications-page-client.tsx` - Notifications list (client)
- `src/app/[locale]/(superadmin)/admin/users/page.tsx` - Platform users page (server)
- `src/app/[locale]/(superadmin)/admin/users/users-page-client.tsx` - Platform users table (client)
- `src/app/[locale]/(superadmin)/admin/actions/users.ts` - User management server actions
- `src/app/[locale]/(superadmin)/admin/actions/health.ts` - System health check server actions
- `src/app/[locale]/(superadmin)/admin/actions/search.ts` - Global search server action
- `src/components/admin/admin-search.tsx` - Global search command palette (Cmd+K)
- `src/lib/n8n/resolve-webhook-url.ts` - Unified webhook URL resolver (with legacy fallbacks)
- `src/lib/n8n/trigger.ts` - n8n webhook trigger and health check
- `src/app/api/webhooks/n8n/analysis-complete/route.ts` - n8n callback webhook handler
- `src/app/[locale]/(superadmin)/admin/jobs/page.tsx` - Analysis jobs page (server)
- `src/app/[locale]/(superadmin)/admin/jobs/jobs-page-client.tsx` - Analysis jobs table with auto-refresh (client)
- `src/app/[locale]/(superadmin)/admin/jobs/[id]/page.tsx` - Job detail page (server)
- `src/app/[locale]/(superadmin)/admin/jobs/[id]/job-detail-client.tsx` - Job detail with timeline (client)
- `src/app/[locale]/(superadmin)/admin/actions/job-detail.ts` - Job detail server action
- `src/app/[locale]/(superadmin)/admin/actions/org-stats.ts` - Org usage stats server action
- `src/app/[locale]/(superadmin)/admin/actions/activity-export.ts` - Audit log CSV export server action
- `src/app/[locale]/(superadmin)/admin/actions/broadcast.ts` - Notification broadcast server actions
- `src/app/[locale]/(superadmin)/admin/integrations/page.tsx` - Integrations page (server)
- `src/app/[locale]/(superadmin)/admin/integrations/integrations-page-client.tsx` - Integrations cards (client)
- `src/app/[locale]/(superadmin)/admin/integrations/actions.ts` - Integration server actions
- `src/lib/crypto/secrets.ts` - AES-256-GCM encryption for integration secrets
- `src/lib/crypto/secrets-cache.ts` - In-memory secret cache with 5-minute TTL
- `src/lib/db/schema/integration-secrets.ts` - Integration secrets table schema
- `src/app/[locale]/(dashboard)/plan/page.tsx` - Org plan view (server)
- `src/app/[locale]/(dashboard)/plan/plan-page-client.tsx` - Plan usage bars and limits (client)
- `src/app/[locale]/(dashboard)/plan/actions.ts` - Plan overview server action
- `src/app/[locale]/(dashboard)/dashboard/plan-widget.tsx` - Dashboard plan widget (client)
- `src/app/[locale]/(superadmin)/admin/plans/page.tsx` - Plans list page (server)
- `src/app/[locale]/(superadmin)/admin/plans/plans-page-client.tsx` - Plans list table (client)
- `src/app/[locale]/(superadmin)/admin/plans/plan-form.tsx` - Shared plan create/edit form (client)
- `src/app/[locale]/(superadmin)/admin/plans/new/page.tsx` - New plan page (server)
- `src/app/[locale]/(superadmin)/admin/plans/[id]/page.tsx` - Plan detail page (server)
- `src/app/[locale]/(superadmin)/admin/plans/[id]/plan-detail-client.tsx` - Plan detail with limits + assigned orgs (client)
- `src/app/[locale]/(superadmin)/admin/plans/[id]/edit/page.tsx` - Plan edit page (server)
- `src/lib/db/schema/products.ts` - Products and organization_products table schemas
- `src/lib/products/limits.ts` - Limits resolution helper (getOrganizationLimits, checkLimit, etc.)
- `src/app/[locale]/(superadmin)/admin/media/page.tsx` - Media library page (server)
- `src/app/[locale]/(superadmin)/admin/media/media-page-client.tsx` - Media library UI (client)
- `src/app/[locale]/(superadmin)/admin/media/actions.ts` - Media server actions
- `src/lib/media/storage-paths.ts` - Storage bucket/path configuration
- `src/lib/media/file-utils.ts` - File size formatting, type checking
- `src/lib/media/track-upload.ts` - Insert media_files record after upload
- `src/lib/media/check-usage.ts` - Check if media file is referenced
- `src/lib/media/sync-storage.ts` - Sync DB with Supabase Storage
- `src/lib/db/schema/media-files.ts` - Media files table schema
- `src/components/admin/sidebar/admin-sidebar.tsx` - Superadmin navigation sidebar (grouped, collapsible)
- `src/components/admin/sidebar/sidebar-config.ts` - Sidebar groups and items configuration
- `src/components/admin/sidebar/sidebar-group.tsx` - Group renderer with section label
- `src/components/admin/sidebar/sidebar-item.tsx` - Single nav item with active indicator
- `src/components/admin/sidebar/sidebar-collapsible.tsx` - Collapsible parent item with children
- `src/components/admin/sidebar/sidebar-user-footer.tsx` - User info, profile link, sign-out
- `src/components/layout/admin-sidebar.tsx` - (legacy, replaced by admin/sidebar/)
- `src/components/layout/dashboard-breadcrumbs.tsx` - Dashboard breadcrumb navigation
- `src/components/admin/breadcrumbs.tsx` - Admin breadcrumb navigation
- `src/components/ui/page-transition.tsx` - Route change animation wrapper
- `src/components/ui/navigation-progress.tsx` - Top progress bar on navigation
- `src/components/ui/empty-state.tsx` - Reusable empty state component
- `src/components/ui/skeletons/skeleton-table.tsx` - Table skeleton loading
- `src/components/ui/skeletons/skeleton-card.tsx` - Card skeleton loading
- `src/components/ui/skeletons/skeleton-form.tsx` - Form skeleton loading
- `src/components/ui/skeletons/skeleton-detail.tsx` - Detail page skeleton loading
- `src/components/ui/skeletons/skeleton-stats.tsx` - Stats grid skeleton loading
- `src/lib/toast-with-undo.ts` - Toast with undo utility
- `src/hooks/use-count-up.ts` - Animated number counter hook
- `src/components/shared/theme-provider.tsx` - next-themes ThemeProvider wrapper
- `src/components/shared/theme-toggle.tsx` - Dark mode toggle dropdown
- `drizzle.config.ts` - Drizzle Kit configuration
- `src/types/form-schema.ts` - Complete TypeScript types for form JSON schema (11 field types, conditions, validation)
- `src/lib/validations/forms.ts` - Zod validators for form schema, fields, metadata, and dynamic submissions
- `src/lib/forms/index.ts` - Form helper functions (get, access check, version, publish)
- `src/components/forms/form-renderer.tsx` - Multi-step form renderer (progress_bar + tabs modes)
- `src/components/forms/form-completion.tsx` - Post-submit completion (thank you / redirect)
- `src/components/forms/fields/*.tsx` - 11 field render components + field-wrapper
- `src/hooks/use-conditional-fields.ts` - Conditional logic evaluation for form fields
- `src/app/[locale]/(dashboard)/forms/page.tsx` - Dashboard forms list (cards)
- `src/app/[locale]/(dashboard)/forms/[slug]/page.tsx` - Form fill page
- `src/app/[locale]/(dashboard)/forms/actions.ts` - Dashboard form server actions
- `src/app/[locale]/(superadmin)/admin/forms/[formId]/submissions/page.tsx` - Admin submissions page
- `src/app/[locale]/(superadmin)/admin/forms/[formId]/submissions/actions.ts` - Submissions server actions
- `src/lib/forms/export.ts` - CSV and XLSX export functions
- `src/app/api/admin/forms/[formId]/submissions/export/route.ts` - Export API route
- `src/components/admin/forms/form-builder/form-settings-dialog.tsx` - Form settings dialog (3 tabs)
- `src/components/admin/forms/form-builder/org-assignment-panel.tsx` - Organization assignment UI
- `src/components/admin/forms/form-builder/publish-validation-dialog.tsx` - Publish validation dialog
- `src/app/[locale]/(dashboard)/analyses/form-assignment-actions.ts` - Form assignment server actions
- `src/app/[locale]/(dashboard)/analyses/_components/forms-section.tsx` - Form assignments card on analysis detail
- `src/app/[locale]/(dashboard)/analyses/_components/assign-form-dialog.tsx` - Assign form dialog
- `src/app/[locale]/(dashboard)/analyses/_components/form-responses-view.tsx` - Submission data display
- `src/app/[locale]/(public)/layout.tsx` - Public layout (no auth)
- `src/app/[locale]/(public)/form-fill/[token]/page.tsx` - Token form-fill page (server)
- `src/app/[locale]/(public)/form-fill/[token]/form-fill-client.tsx` - Token form-fill UI (client)
- `src/app/[locale]/(public)/form-fill/[token]/actions.ts` - Token validation and submission actions
- `src/lib/db/schema/forms.ts` - Drizzle schema for forms, form_versions, form_organization_assignments, form_submissions
- `src/lib/db/schema/analysis-form-assignments.ts` - Analysis form assignments table schema
- `src/lib/db/schema/org-email-template-overrides.ts` - Org email template overrides table schema
- `src/lib/db/schema/enums.ts` - All PostgreSQL enums (incl. platform_role, invitation_status, form_status, form_visibility, analysis_form_assignment_status)
- `src/lib/db/schema/organizations.ts` - Organizations table
- `src/lib/db/schema/users.ts` - Users table (with platform_role, extended profile fields)
- `src/lib/db/schema/organization-members.ts` - Org members junction table
- `src/lib/db/schema/analysis-subjects.ts` - Analysis subjects table
- `src/lib/db/schema/consents.ts` - Consents table
- `src/lib/db/schema/analysis-jobs.ts` - Analysis jobs table
- `src/lib/db/schema/reports.ts` - Reports table
- `src/lib/db/schema/team-invitations.ts` - Team invitations table
- `src/lib/db/schema/index.ts` - Schema re-exports
- `src/lib/db/index.ts` - Drizzle client instance
- `src/lib/supabase/client.ts` - Browser Supabase client
- `src/lib/supabase/server.ts` - Server-side Supabase client
- `src/lib/supabase/admin.ts` - Service-role client (superadmin)
- `src/lib/supabase/middleware.ts` - Auth middleware helper
- `src/lib/auth/roles.ts` - RBAC role definitions (org + platform roles)
- `src/lib/auth/permissions.ts` - Permission check functions
- `src/lib/auth/require-platform-role.ts` - Server-side platform role guard
- `src/lib/validations/admin.ts` - Zod schemas for admin forms
- `src/types/database.ts` - Drizzle inferred types
- `src/types/index.ts` - Type re-exports
- `supabase/migrations/001_enable_rls.sql` - Enable RLS on all tables
- `supabase/migrations/002_tenant_isolation_policies.sql` - Tenant isolation policies
- `src/middleware.ts` - Three-layer middleware (locale + subdomain + auth)
- `src/lib/i18n/request.ts` - next-intl server request config
- `src/lib/i18n/routing.ts` - Locale routing definition
- `src/lib/i18n/navigation.ts` - next-intl navigation helpers
- `src/app/[locale]/(auth)/layout.tsx` - Auth layout (centered card)
- `src/app/[locale]/(auth)/login/page.tsx` - Login page with Supabase auth
- `src/app/[locale]/(auth)/register/page.tsx` - Register page with Supabase auth
- `src/app/api/auth/callback/route.ts` - Auth callback for magic link/OAuth
- `src/hooks/use-tenant.ts` - Client-side organization context hook
- `src/hooks/use-role.ts` - Client-side user role hook (platformRole + orgRole)
- `src/lib/constants.ts` - App constants
- `src/lib/utils.ts` - cn() utility
- `src/messages/de.json` / `en.json` - Comprehensive translation files
- `.env.example` - Environment variable template
